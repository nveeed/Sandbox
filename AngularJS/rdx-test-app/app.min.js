'use strict';

// Declare app level module which depends on views, and components
angular.module('myApp', [
    'ngRoute',
    'myApp.products',
    'myApp.categories'
]).
config(['$routeProvider', '$locationProvider', function($routeProvider,$locationProvider) {
    $routeProvider.
        when('/', {
            templateUrl: 'partials/products.html',
            controller: 'ProductsCtrl'
        }).
        otherwise({redirectTo: '/'});
    $locationProvider.html5Mode(true);
}]);

// @codekit-append "js/config.js"
// @codekit-append "js/categories.js"
var rdxTestAppGlobalVars = {
    baseUrl: "http://localhost/--Sandbox--/AngularJS/rdx-test-app",
    apiUrl: "http://rdxsports.info/custom-api/index/"
};
angular.module('myApp.categories', [])
.controller('CategoriesCtrl', ['$rootScope','$http', function(scope,$http) {
    $("#loading-div").show();
    $http.get(rdxTestAppGlobalVars.apiUrl+"categories").then(function (response) {
        scope.categories = response.data.data;
        scope.activeCategory = scope.categories[0];
        $("#loading-div").hide();
    });

    scope.setActiveCat = function (category) {
        scope.activeCategory = category;
    }
}]);
angular.module('myApp.products', ['ngRoute','ngSanitize'])
.config(['$routeProvider', function($routeProvider) {
    $routeProvider.when('/products', {
        templateUrl: 'partials/products.html',
        controller: 'ProductsCtrl'
    });
}])
.controller('ProductsCtrl', ['$scope','$http', function(scope,$http) {
        scope.curPage = 1;
        scope.pageSize = 10;
        scope.products = [];

        var url = function () {
            return rdxTestAppGlobalVars.apiUrl+"products" +
            "?category="+ scope.activeCategory.entity_id +
            "&curPage=" + scope.curPage +
            "&pageSize=" + scope.pageSize;
        };

        scope.$watch('activeCategory', function(category){
            scope.products = [];
            loadProducts();
        });

        scope.loadMoreProducts = function () {
            loadProducts();
        };

        var loadProducts = function () {
            $("#loading-div").show();
            $http.get(url()).then(function (response) {
                scope.products = scope.products.concat(response.data.data);
                $("#loading-div").hide();
            });
        };

}]);